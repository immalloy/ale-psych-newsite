<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALE Psych Engine Cookbook</title>
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/icons/cookbook/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/icons/cookbook/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="../assets/icons/cookbook/favicon-16.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="../assets/icons/cookbook/favicon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="../assets/icons/cookbook/favicon-512.png" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #140c08;
      --panel: #22130b;
      --panel-alt: #1b100a;
      --text: #f5efe8;
      --muted: #d0b9a5;
      --border: #3b2417;
      --accent: #ff9f43;
      --accent-strong: #ffb665;
      --glow: rgba(255, 159, 67, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      grid-template-columns: 280px 1fr;
    }

    header {
      grid-column: 1 / -1;
      padding: 20px 28px;
      background: linear-gradient(120deg, #25150d 0%, #2d1a10 60%, #2a1408 100%);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 12px 24px rgba(7, 3, 1, 0.4);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-home {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255, 159, 67, 0.4);
      color: var(--text);
      text-decoration: none;
      background: rgba(255, 159, 67, 0.12);
      box-shadow: 0 8px 16px rgba(10, 4, 1, 0.35);
      font-size: 14px;
      font-weight: 600;
    }

    .header-home:hover,
    .header-home:focus-visible {
      background: rgba(255, 159, 67, 0.22);
      border-color: rgba(255, 159, 67, 0.7);
    }

    .header-icon {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: radial-gradient(circle at top, #ffcb87 0%, #ff9f43 45%, #c5691c 100%);
      padding: 8px;
      box-shadow: 0 8px 20px rgba(255, 159, 67, 0.25);
    }

    .header-icon img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    #layout {
      display: contents;
    }

    aside {
      padding: 20px;
      background: var(--panel-alt);
      border-right: 1px solid var(--border);
      overflow-y: auto;
    }

    main {
      padding: 28px 36px 40px;
      overflow-y: auto;
    }

    .search {
      margin-bottom: 18px;
    }

    .search input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #1a0f09;
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255, 159, 67, 0.04);
    }

    .category {
      margin-bottom: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: #1a0f09;
      box-shadow: 0 10px 18px rgba(10, 4, 1, 0.3);
    }

    .category summary {
      cursor: pointer;
      list-style: none;
      padding: 10px 12px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      letter-spacing: 0.2px;
    }

    .category summary::-webkit-details-marker {
      display: none;
    }

    .category ul {
      list-style: none;
      margin: 0;
      padding: 6px 0;
    }

    .category li {
      margin: 0;
    }

    .doc-link {
      display: block;
      padding: 8px 12px;
      color: var(--muted);
      text-decoration: none;
      border-left: 2px solid transparent;
    }

    .doc-link:hover,
    .doc-link:focus {
      color: var(--text);
      background: var(--glow);
    }

    .doc-link.active {
      color: var(--text);
      border-left-color: var(--accent);
      background: rgba(255, 159, 67, 0.2);
    }

    .content h1 {
      margin-top: 0;
      font-size: 28px;
      color: var(--accent-strong);
    }

    .content h2 {
      margin-top: 24px;
      font-size: 20px;
      color: var(--accent);
    }

    .content p,
    .content li {
      color: var(--muted);
      line-height: 1.6;
    }

    .content ul {
      padding-left: 20px;
    }

    .content ol {
      padding-left: 24px;
    }

    .content hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 24px 0;
    }

    .content blockquote {
      margin: 16px 0;
      padding: 12px 16px;
      border-left: 3px solid var(--accent);
      background: rgba(255, 159, 67, 0.08);
      color: var(--muted);
    }

    .content pre {
      background: #1a0f09;
      padding: 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      overflow-x: auto;
      box-shadow: inset 0 0 0 1px rgba(255, 159, 67, 0.05);
    }

    .content code {
      font-family: "Consolas", "SFMono-Regular", monospace;
      color: var(--text);
    }

    @media (max-width: 900px) {
      body {
        grid-template-columns: 1fr;
      }

      aside {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-brand">
      <div class="header-icon">
        <img src="../assets/icons/cookbook/favicon-512.png" alt="Cookbook icon" />
      </div>
      <h1>ALE Psych Engine Cookbook</h1>
    </div>
    <div class="header-actions">
      <a class="header-home" href="../index.html">Back to homepage</a>
    </div>
  </header>
  <div id="layout">
    <aside>
      <div class="search">
        <input id="search" type="text" placeholder="Search pages" aria-label="Search pages" />
      </div>
      <nav id="sidebar"></nav>
    </aside>
    <main>
      <div id="content" class="content">
        <h1>Loading</h1>
        <p>Fetching documentation data.</p>
      </div>
    </main>
  </div>

  <script>
    const dataUrl = 'cookbook-data.json';
    const sidebar = document.getElementById('sidebar');
    const content = document.getElementById('content');
    const searchInput = document.getElementById('search');

    let docs = [];
    let linkElements = new Map();

    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function renderMarkdown(markdown) {
      const stripped = markdown.replace(/^---[\s\S]*?---\s*/, '');
      const lines = stripped.split(/\r?\n/);
      let html = '';
      let inList = false;
      let listType = null;
      let inCode = false;

      const closeList = () => {
        if (inList && listType) {
          html += `</${listType}>`;
        }
        inList = false;
        listType = null;
      };

      const openList = (type) => {
        if (!inList || listType !== type) {
          closeList();
          html += `<${type}>`;
          inList = true;
          listType = type;
        }
      };

      for (const line of lines) {
        if (line.startsWith('```')) {
          if (!inCode) {
            closeList();
            inCode = true;
            html += '<pre><code>';
          } else {
            inCode = false;
            html += '</code></pre>';
          }
          continue;
        }

        if (inCode) {
          html += `${escapeHtml(line)}\n`;
          continue;
        }

        const trimmedLine = line.trim();

        if (!trimmedLine) {
          closeList();
          continue;
        }

        if (trimmedLine === '---') {
          closeList();
          html += '<hr />';
          continue;
        }

        if (trimmedLine.startsWith('# ')) {
          closeList();
          html += `<h1>${escapeHtml(trimmedLine.slice(2).trim())}</h1>`;
          continue;
        }

        if (trimmedLine.startsWith('## ')) {
          closeList();
          html += `<h2>${escapeHtml(trimmedLine.slice(3).trim())}</h2>`;
          continue;
        }

        if (trimmedLine.startsWith('### ')) {
          closeList();
          html += `<h3>${escapeHtml(trimmedLine.slice(4).trim())}</h3>`;
          continue;
        }

        if (trimmedLine.startsWith('> ')) {
          closeList();
          html += `<blockquote>${escapeHtml(trimmedLine.slice(2).trim())}</blockquote>`;
          continue;
        }

        if (trimmedLine.startsWith('- ')) {
          openList('ul');
          html += `<li>${escapeHtml(trimmedLine.slice(2).trim())}</li>`;
          continue;
        }

        if (/^\d+\.\s+/.test(trimmedLine)) {
          openList('ol');
          html += `<li>${escapeHtml(trimmedLine.replace(/^\d+\.\s+/, '').trim())}</li>`;
          continue;
        }

        closeList();
        html += `<p>${escapeHtml(trimmedLine)}</p>`;
      }

      if (inCode) {
        html += '</code></pre>';
      }

      closeList();
      return html || '<p>No content available.</p>';
    }

    function setActiveLink(slug) {
      linkElements.forEach((link, key) => {
        link.classList.toggle('active', key === slug);
      });
    }

    function loadDoc(doc) {
      if (!doc) {
        content.innerHTML = '<h1>Document not found</h1><p>Please select a page from the sidebar.</p>';
        return;
      }
      setActiveLink(doc.slug);
      fetch(doc.path)
        .then((res) => res.text())
        .then((text) => {
          content.innerHTML = renderMarkdown(text);
        })
        .catch(() => {
          content.innerHTML = '<h1>Unable to load document</h1><p>Please try again later.</p>';
        });
    }

    function buildSidebar(items) {
      sidebar.innerHTML = '';
      linkElements = new Map();
      const categories = new Map();

      items.forEach((item) => {
        if (!categories.has(item.category)) {
          categories.set(item.category, []);
        }
        categories.get(item.category).push(item);
      });

      categories.forEach((docsInCategory, categoryName) => {
        const details = document.createElement('details');
        details.className = 'category';
        details.open = true;

        const summary = document.createElement('summary');
        summary.textContent = categoryName;
        details.appendChild(summary);

        const list = document.createElement('ul');
        docsInCategory.forEach((doc) => {
          const listItem = document.createElement('li');
          const link = document.createElement('a');
          link.href = `#${doc.slug}`;
          link.textContent = doc.title;
          link.className = 'doc-link';
          link.addEventListener('click', (event) => {
            event.preventDefault();
            history.replaceState(null, '', `#${doc.slug}`);
            loadDoc(doc);
          });
          linkElements.set(doc.slug, link);
          listItem.appendChild(link);
          list.appendChild(listItem);
        });

        details.appendChild(list);
        sidebar.appendChild(details);
      });
    }

    function filterSidebar(query) {
      const normalized = query.trim().toLowerCase();
      const matchingDocs = normalized
        ? docs.filter((doc) => doc.title.toLowerCase().includes(normalized))
        : docs;

      buildSidebar(matchingDocs);

      if (matchingDocs.length) {
        matchingDocs.forEach((doc) => {
          if (doc.slug === location.hash.replace('#', '')) {
            setActiveLink(doc.slug);
          }
        });
      }
    }

    function findDocBySlug(slug) {
      return docs.find((doc) => doc.slug === slug) || docs[0];
    }

    fetch(dataUrl)
      .then((res) => res.json())
      .then((data) => {
        docs = data;
        buildSidebar(docs);
        const initialSlug = location.hash.replace('#', '');
        const initialDoc = findDocBySlug(initialSlug);
        loadDoc(initialDoc);
      })
      .catch(() => {
        content.innerHTML = '<h1>Unable to load cookbook data</h1><p>Please check the data file.</p>';
      });

    window.addEventListener('hashchange', () => {
      const slug = location.hash.replace('#', '');
      loadDoc(findDocBySlug(slug));
    });

    searchInput.addEventListener('input', (event) => {
      filterSidebar(event.target.value);
    });
  </script>
</body>
</html>
